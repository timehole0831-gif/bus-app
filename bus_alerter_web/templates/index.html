<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 버스 도착 알리미 (최종본)</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* (모든 CSS 스타일은 이전과 동일) */
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            max-width: 800px; margin: 40px auto; padding: 0 20px; background-color: #f8f9fa; color: #343a40;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }

        h1, h2, .top-button-row > button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #212529;
            margin-bottom: 25px;
            font-weight: 700;
        }
        h2 { gap: 6px; margin-top: 35px; margin-bottom: 20px; font-size: 1.6em; }
        h1 { font-size: 2.2em; margin-bottom: 30px; }

        .form-group-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .form-group-row > div { flex: 1; }
        .form-group { margin-bottom: 25px;}
        label { display: block; margin-bottom: 10px; font-weight: 500; color: #343a40; }
        input, select {
            width: 100%; padding: 14px; border-radius: 8px; border: 1px solid #dee2e6; box-sizing: border-box;
            font-size: 17px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.2);
        }

        button {
            width: 100%; padding: 16px; background-color: #007bff; color: white; border: none;
            border-radius: 8px; font-size: 19px; font-weight: 700; cursor: pointer;
            transition: background-color 0.3s, transform 0.1s ease-out, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0,123,255,0.2);
            letter-spacing: 0.5px;
        }
        button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,123,255,0.3);
        }
        button:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(0,123,255,0.2); }
        button:disabled { background-color: #cccccc; cursor: not-allowed; box-shadow: none; transform: none; }

        .loader { display: none; align-items: center; justify-content: center; margin-top: 25px; font-size: 1.1em; color: #005a9c; gap: 10px; font-weight: 500; }
        .loader::before { content: ''; width: 20px; height: 20px; border: 3px solid #005a9c; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error { color: #d93025; background-color: #fbe9e7; border: 1px solid #f29c95; padding: 15px; border-radius: 8px; text-align: center; margin-top: 20px; display: none; font-weight: 500; }

        .top-button-row { display: flex; gap: 12px; margin-bottom: 25px; }
        .top-button-row > button { flex: 1; font-size: 17px; padding: 14px; font-weight: 500; }

        .top-button-row > button .material-symbols-outlined {
            position: relative;
            top: 2px;
            font-size: 1.3em;
        }

        button.notify-btn {
            background-color: #198754;
            box-shadow: 0 4px 10px rgba(25,135,84,0.2);
            color: white;
        }
        button.notify-btn:hover {
            background-color: #157347;
            box-shadow: 0 6px 15px rgba(25,135,84,0.3);
        }
        button.notify-btn:disabled {
             background-color: #198754;
             opacity: 0.7;
             box-shadow: none;
             transform: none;
             color: white;
        }

        button.map-btn {
            background-color: #6c757d;
            color: white;
            box-shadow: 0 4px 10px rgba(108,117,125,0.2);
        }
        button.map-btn:hover {
            background-color: #5a6268;
            box-shadow: 0 6px 15px rgba(108,117,125,0.3);
        }

        #favorites-section { margin-top: 35px; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 25px; }
        #favorites-list { list-style: none; padding: 0; }
        .fav-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 12px; background-color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s; }
        .fav-item:hover { background-color: #f8f9fa; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-2px); }
        .fav-item-info { cursor: pointer; flex-grow: 1; }
        .fav-item-info b { font-size: 1.2em; color: #212529; }
        .fav-item-info span { font-size: 0.95em; color: #6c757d; display: block; margin-top: 5px; }
        .fav-remove-btn { background: none; border: none; color: #6c757d; font-size: 1.6em; cursor: pointer; padding: 5px; width: auto; opacity: 0.7; transition: opacity 0.2s, color 0.2s; }
        .fav-remove-btn:hover { opacity: 1; color: #d93025; transform: scale(1.1); }

        .station-choice-list { list-style: none; padding: 0; max-height: 280px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; background-color: #fff; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
        .station-choice-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; transition: background-color 0.2s; }
        .station-choice-item:last-child { border-bottom: none; }
        .station-choice-item:hover { background-color: #f8f9fa; cursor: pointer; }
        .station-choice-info { flex-grow: 1; font-size: 1.1em; color: #343a40; }
        .station-choice-info small { color: #6c757d; margin-left: 10px; font-size: 0.9em; }

        .route-list { list-style: none; padding: 0; }
        .route-item { display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; margin-bottom: 12px; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: box-shadow 0.2s, transform 0.2s; }
        .route-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-2px); }
        .route-info { padding: 18px; flex-grow: 1; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
        .route-info:hover { background-color: #f8f9fa; border-radius: 8px 0 0 8px; }
        .route-info-main { display: flex; flex-direction: column; }
        .route-name { font-weight: 700; font-size: 1.25em; color: #212529; }
        .route-direction { font-size: 0.85em; color: #6c757d; margin-top: 4px; }
        .route-type { font-size: 0.9em; font-weight: 500; padding: 4px 8px; border-radius: 4px; color: white; background-color: #95a5a6; }
        .route-info.type-red .route-type { background-color: #e64c3c; }
        .route-info.type-blue .route-type { background-color: #3498db; }
        .route-info.type-green .route-type { background-color: #2ecc71; }
        .route-info.type-yellow .route-type { background-color: #f1c40f; color: #333; }
        .route-info.type-gray .route-type { background-color: #95a5a6; }

        .fav-toggle-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; padding: 0 15px; width: auto; color: #ced4da; transition: color 0.2s, transform 0.1s; display: flex; align-items: center; }
        .fav-toggle-btn .material-symbols-outlined { font-size: 1.3em; font-variation-settings: 'FILL' 0; }
        .fav-toggle-btn:hover { color: #f0c300; transform: scale(1.1); }
        .fav-toggle-btn.favorited { color: #f0c300; }
        .fav-toggle-btn.favorited .material-symbols-outlined { font-variation-settings: 'FILL' 1; }

        #station-name { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 30px; margin-bottom: 25px; font-size: 1.8em; font-weight: 700; flex-wrap: wrap; }
        #station-name span { color: #212529; }
        .map-link { font-size: 0.6em; font-weight: 500; text-decoration: none; padding: 6px 10px; background-color: #e9ecef; border-radius: 20px; color: #6c757d; white-space: nowrap; transition: background-color 0.2s, box-shadow 0.2s; display: flex; align-items: center; gap: 5px; }
        .map-link:hover { background-color: #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .map-link .material-symbols-outlined { font-size: 1.2em; }

        .arrival-card { padding: 25px; background-color: #eaf6ff; border-left: 6px solid #007bff; border-radius: 8px; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,123,255,0.1); }
        .arrival-entry { border-bottom: 1px dashed #bde0fe; padding: 12px 0; }
        .arrival-entry:last-child { border-bottom: none; }
        .arrival-entry p { margin: 6px 0; font-size: 1.15em; line-height: 1.4; }
        .arrival-entry .label { font-weight: 700; color: #005a9c; font-size: 1.05em; margin-right: 5px; }
        .arrival-entry b { color: #d93025; font-size: 1.2em; }
        #arrival-timer { font-size: 0.9em; color: #6c757d; text-align: center; margin-top: 20px; font-weight: 500; }

        #help-btn { position: absolute; top: 25px; right: 25px; cursor: pointer; font-size: 1.5em; background: none; border-radius: 50%; width: 36px; height: 36px; text-align: center; line-height: 36px; color: #adb5bd; user-select: none; z-index: 10; transition: background-color 0.2s, color 0.2s, transform 0.2s; font-variation-settings: 'FILL' 0; }
        #help-btn:hover { background-color: #f1f3f5; color: #343a40; transform: rotate(15deg); }

        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 25px 35px 35px 35px; border: 1px solid #aaa; border-radius: 10px; width: 90%; max-width: 550px; position: relative; animation: fadeIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 8px 30px rgba(0,0,0,0.2); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        .modal-close { color: #aaa; float: right; font-size: 32px; font-weight: bold; position: absolute; top: 15px; right: 20px; transition: color 0.2s; }
        .modal-close:hover, .modal-close:focus { color: #333; text-decoration: none; cursor: pointer; }
        .modal-content h2 { margin-top: 10px; color: #212529; font-size: 1.8em; }
        .modal-content p { text-align: center; line-height: 1.8; font-size: 1.1em; color: #343a40; margin-bottom: 15px; }
        .modal-content img { width: 90%; max-width: 450px; margin: 20px auto; display: block; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .modal-content p strong { color: #d93025; font-size: 1.3em; }

        @media (max-width: 600px) {
            body { margin: 0; padding: 0; background-color: white; }
            .container { margin: 0 auto; padding: 20px 15px; border-radius: 0; box-shadow: none; min-height: 100vh; }
            h1 { font-size: 1.8em; margin-bottom: 20px; }
            h2 { font-size: 1.4em; margin-top: 25px; margin-bottom: 15px; }
            .top-button-row { flex-direction: column; gap: 12px; margin-bottom: 20px; }
            .top-button-row > button { font-size: 17px; padding: 14px; }
            .form-group-row { flex-direction: column; gap: 15px; margin-bottom: 15px; }
            label { margin-bottom: 8px; font-size: 0.95em; }
            input, select { padding: 12px; font-size: 16px; }
            button { padding: 14px; font-size: 17px; }
            #help-btn { top: 15px; right: 15px; width: 32px; height: 32px; line-height: 32px; font-size: 1.3em; }
            .modal-content { padding: 20px 25px 25px 25px; width: 95%; }
            .modal-content h2 { font-size: 1.5em; }
            .modal-content p { font-size: 1em; margin-bottom: 10px; }
            .modal-content img { margin: 15px auto; }
            #favorites-section { margin-top: 25px; padding-bottom: 15px; }
            .fav-item { padding: 12px; margin-bottom: 10px; }
            .fav-item-info b { font-size: 1.1em; }
            .fav-item-info span { font-size: 0.85em; }
            .station-choice-item, .route-info { padding: 15px; }
            .route-name { font-size: 1.15em; }
            .route-direction { font-size: 0.8em; }
            #station-name { font-size: 1.5em; margin-top: 25px; margin-bottom: 20px; gap: 8px; }
            .map-link { font-size: 0.55em; padding: 5px 9px; }
            .arrival-card { padding: 20px; }
            .arrival-entry p { font-size: 1.05em; }
            .arrival-entry .label { font-size: 1em; }
            .arrival-entry b { font-size: 1.1em; }
        }
    </style>
</head>
<body>
<div class="container">
    <span id="help-btn" class="material-symbols-outlined">help_outline</span>

    <h1><span class="material-symbols-outlined">directions_bus</span> 실시간 버스 도착 알리미</h1>

    <div class="top-button-row">
        <button id="notification-button" class="notify-btn"><span class="material-symbols-outlined">notifications_active</span> 바탕화면 알림 허용하기</button>
        <button id="show-map-btn" class="map-btn"><span class="material-symbols-outlined">map</span> 지도 보기</button>
    </div>

    <div id="favorites-section" style="display: none;">
        <h2><span class="material-symbols-outlined">star</span> 즐겨찾기</h2>
        <ul id="favorites-list"></ul>
    </div>

    <div class="form-group-row">
        <div>
            <label for="region-select">지역 선택</label>
            <select id="region-select"></select>
        </div>
        <div>
            <label for="city-select">도시/행정구역 선택</label>
            <select id="city-select"></select>
        </div>
    </div>
    <div class="form-group">
        <label id="search-label" for="search-query">정류소 번호 (5자리)</label>
        <input type="text" id="search-query" placeholder="정류장 표지판의 번호를 입력하세요">
    </div>
    <button id="search-button" onclick="searchStation()">조회하기</button>

    <div class="loader">조회 중...</div>
    <div id="error-message" class="error"></div>
    <div id="station-choices" style="display: none;">
        <h2><span class="material-symbols-outlined">location_on</span> 정류소를 선택하세요</h2>
        <ul id="station-choice-list" class="station-choice-list"></ul>
    </div>
    <div id="results" style="display: none;">
        <h2 id="station-name"></h2>
        <ul id="route-list" class="route-list"></ul>
    </div>
    <div id="arrival-info" style="display: none;">
        <h2 id="arrival-title"></h2>
        <div id="arrival-details" class="arrival-card"></div>
        <div id="arrival-timer"></div>
    </div>
</div>

<div id="help-modal" class="modal-overlay">
    <div class="modal-content">
        <span id="modal-close-btn" class="modal-close">&times;</span>
        <h2 style="margin-top: 0;"><span class="material-symbols-outlined">info</span> '정류소 번호'란?</h2>
        <p>정류소 번호는 버스 정류장 표지판에서<br>찾을 수 있는 <strong>5자리 고유 숫자</strong>입니다.</p>
        <p>아래 예시 사진을 참고하세요.</p>
        <img src="/static/help-image.png" alt="정류소 번호 예시">
        <p style="text-align: center; color: #333;">
            예시) '광교중앙.경기도청' 정류소의 번호는 <strong style="color: #d93025; font-size: 1.2em;">04397</strong> 입니다.
        </p>
    </div>
</div>

<script>
    const regionData = {{ region_data|tojson }};
    const VAPID_PUBLIC_KEY = '{{ vapid_public_key }}';
    let stationData = {};
    let arrivalInterval;
    let timerInterval;
    let countdown = 30;
    let currentCityCode = '';
    const FAVORITES_KEY = 'busFavorites';

    function getFavorites() { return JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]'); }
    function saveFavorites(favorites) { localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites)); }
    function getFavoriteId(stationId, routeId) { return `${stationId}-${routeId}`; }
    function isFavorite(favId) { return getFavorites().some(fav => fav.favId === favId); }
    function addFavorite(favObject) { const f = getFavorites(); if (!isFavorite(favObject.favId)) { f.push(favObject); saveFavorites(f); } }
    function removeFavorite(favId) { let f = getFavorites(); f = f.filter(fav => fav.favId !== favId); saveFavorites(f); }

    document.addEventListener('DOMContentLoaded', () => {
        loadAndDisplayFavorites();

        const regionSelect = document.getElementById('region-select');
        for (const regionName in regionData) { regionSelect.add(new Option(regionName, regionName)); }
        regionSelect.addEventListener('change', updateCitySelect);
        regionSelect.dispatchEvent(new Event('change'));

        const notificationButton = document.getElementById('notification-button');
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            notificationButton.addEventListener('click', () => {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then(swReg => askPermissionAndSubscribe(swReg))
                    .catch(error => console.error('서비스 워커 등록 실패:', error));
            });
        } else {
            notificationButton.innerHTML = '<span class="material-symbols-outlined">notifications_off</span> 알림 지원 안됨';
            notificationButton.disabled = true;
            notificationButton.style.backgroundColor = '#6c757d';
        }

        document.getElementById('show-map-btn').addEventListener('click', openDefaultMap);

        const helpBtn = document.getElementById('help-btn');
        const helpModal = document.getElementById('help-modal');
        const closeModalBtn = document.getElementById('modal-close-btn');

        helpBtn.onclick = () => { helpModal.style.display = 'flex'; }
        closeModalBtn.onclick = () => { helpModal.style.display = 'none'; }
        helpModal.onclick = (event) => {
            if (event.target == helpModal) { helpModal.style.display = 'none'; }
        }
    });

    function openDefaultMap() {
        const mapUrl = `https://map.kakao.com/link/map/경기도청,37.2882,127.0517`;
        window.open(mapUrl, '_blank');
    }

    function loadAndDisplayFavorites() {
        const favorites = getFavorites();
        const listEl = document.getElementById('favorites-list');
        const sectionEl = document.getElementById('favorites-section');
        listEl.innerHTML = '';
        if (favorites.length === 0) {
            sectionEl.style.display = 'block';
            listEl.innerHTML = '<li style="text-align: center; color: #777; padding: 20px 0; font-size: 0.95em;">즐겨찾는 버스가 없습니다.<br>노선 목록에서 <span class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle; color: #f0c300; font-variation-settings: \'FILL\' 0;">star</span>을 눌러 추가해보세요.</li>';
            return;
        }
        sectionEl.style.display = 'block';
        favorites.forEach(fav => {
            const li = document.createElement('li');
            li.className = 'fav-item';
            const info = document.createElement('div');
            info.className = 'fav-item-info';
            info.innerHTML = `<b>${fav.busNumber}번 버스</b> <span>@ ${fav.stationName}</span>`;
            info.onclick = () => {
                getArrivalInfo(fav.routeId, fav.busNumber, fav.stationId, fav.stationName, fav.cityCode);
                document.getElementById('arrival-info').scrollIntoView({ behavior: 'smooth' });
            };
            const removeBtn = document.createElement('button');
            removeBtn.className = 'fav-remove-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.onclick = () => {
                removeFavorite(fav.favId);
                loadAndDisplayFavorites();
                if (document.getElementById('results').style.display === 'block') {
                    displayBusRoutes(stationData.routes);
                }
            };
            li.appendChild(info);
            li.appendChild(removeBtn);
            listEl.appendChild(li);
        });
    }

    function updateCitySelect() {
        const regionSelect = document.getElementById('region-select');
        const citySelect = document.getElementById('city-select');
        const selectedRegion = regionSelect.value;
        const cities = regionData[selectedRegion];
        citySelect.innerHTML = '';
        for (const cityName in cities) { citySelect.add(new Option(cityName, cities[cityName])); }
        citySelect.dispatchEvent(new Event('change'));
    }

    document.getElementById('city-select').addEventListener('change', (event) => {
        const cityCode = event.target.value;
        const searchLabel = document.getElementById('search-label');
        const searchInput = document.getElementById('search-query');
        if (cityCode.length < 5) {
            searchLabel.textContent = '정류소 이름';
            searchInput.placeholder = '예: 강남역, 시청';
        } else {
            searchLabel.textContent = '정류소 번호 (5자리)';
            searchInput.placeholder = '정류장 표지판의 번호를 입력하세요';
        }
    });

    async function searchStation() {
        clearAllResults();
        currentCityCode = document.getElementById('city-select').value;
        const query = document.getElementById('search-query').value.trim();
        if (!query) { showError('검색어를 입력해주세요.'); return; }
        showLoader(true);
        try {
            const response = await fetch(`/api/search-station?cityCode=${currentCityCode}&query=${query}`);
            if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error); }
            const stations = await response.json();
            if (stations.length === 1 && currentCityCode.length >= 5) {
                await getRoutesForStation(stations[0]);
            } else {
                displayStationChoices(stations);
            }
        } catch (error) { showError(error.message); } finally { showLoader(false); }
    }

    function displayStationChoices(stations) {
        const choicesDiv = document.getElementById('station-choices');
        const choiceList = document.getElementById('station-choice-list');
        choiceList.innerHTML = '';
        stations.forEach(station => {
            const li = document.createElement('li');
            li.className = 'station-choice-item';
            const info = document.createElement('div');
            info.className = 'station-choice-info';
            info.textContent = station.nodenm;
            if (station.nodeno) { const small = document.createElement('small'); small.textContent = `(${station.nodeno})`; info.appendChild(small); }
            info.onclick = () => getRoutesForStation(station);
            const mapLink = document.createElement('a');
            mapLink.href = `https://map.kakao.com/link/map/${station.nodenm},${station.gpslati},${station.gpslong}`;
            mapLink.target = '_blank';
            mapLink.className = 'map-link';
            mapLink.innerHTML = '<span class="material-symbols-outlined" style="font-size: 1.2em; vertical-align: middle;">near_me</span> 지도';
            li.appendChild(info);
            li.appendChild(mapLink);
            choiceList.appendChild(li);
        });
        choicesDiv.style.display = 'block';
    }

    async function getRoutesForStation(station) {
        clearAllResults();
        showLoader(true);
        const nodeId = station.nodeid;
        const nodeName = station.nodenm;
        try {
            const cityCode = station.citycode || currentCityCode;
            currentCityCode = cityCode;

            const response = await fetch(`/api/get-routes?cityCode=${cityCode}&nodeId=${nodeId}`);
            if (!response.ok) { throw new Error( (await response.json()).error ); }
            const routes = await response.json();
            stationData = {
                stationInfo: {
                    nodeid: nodeId,
                    nodenm: nodeName,
                    citycode: cityCode,
                    gpsLati: station.gpslati,
                    gpsLong: station.gpslong
                },
                routes: routes
            };
            displayBusRoutes(routes);
        } catch (error) {
            showError(error.message);
        } finally {
            showLoader(false);
        }
    }

    function getBusTypeClass(routeType) {
        if (routeType.includes('광역') || routeType.includes('직행')) return 'type-red';
        if (routeType.includes('간선') || routeType.includes('좌석')) return 'type-blue';
        if (routeType.includes('일반') || routeType.includes('지선')) return 'type-green';
        if (routeType.includes('마을') || routeType.includes('순환')) return 'type-yellow';
        return 'type-gray';
    }

    function displayBusRoutes(routes) {
        const resultsDiv = document.getElementById('results');
        const stationNameEl = document.getElementById('station-name');
        const routeList = document.getElementById('route-list');
        const { nodenm, gpsLati, gpsLong } = stationData.stationInfo;
        const mapLink = `https://map.kakao.com/link/map/${nodenm},${gpsLati},${gpsLong}`;
        stationNameEl.innerHTML = `<span>'${nodenm}' 정류소 운행 노선</span> <a href="${mapLink}" target="_blank" class="map-link"><span class="material-symbols-outlined">near_me</span> 지도 보기</a>`;

        routeList.innerHTML = '';
        routes.forEach(route => {
            const li = document.createElement('li');
            li.className = 'route-item';
            const info = document.createElement('div');
            const busTypeClass = getBusTypeClass(route.routetp);
            info.className = `route-info ${busTypeClass}`;

            info.innerHTML = `<div class="route-info-main">
                                <span class="route-name">${route.routeno}번 버스</span>
                                <span class="route-direction">${route.endnodenm} 방면</span>
                              </div>
                              <span class="route-type">${route.routetp}</span>`;

            info.onclick = () => getArrivalInfo(route.routeid, route.routeno, stationData.stationInfo.nodeid, stationData.stationInfo.nodenm, stationData.stationInfo.citycode);

            const favBtn = document.createElement('button');
            favBtn.className = 'fav-toggle-btn';
            const favId = getFavoriteId(stationData.stationInfo.nodeid, route.routeid);

            if (isFavorite(favId)) {
                favBtn.innerHTML = '<span class="material-symbols-outlined">star</span>';
                favBtn.classList.add('favorited');
            } else {
                favBtn.innerHTML = '<span class="material-symbols-outlined">star_border</span>';
            }

            const favObject = {
                favId: favId, cityCode: stationData.stationInfo.citycode, stationId: stationData.stationInfo.nodeid,
                stationName: stationData.stationInfo.nodenm, routeId: route.routeid, busNumber: route.routeno, busType: route.routetp
            };
            favBtn.onclick = () => {
                if (isFavorite(favId)) {
                    removeFavorite(favId);
                    favBtn.innerHTML = '<span class="material-symbols-outlined">star_border</span>';
                    favBtn.classList.remove('favorited');
                } else {
                    addFavorite(favObject);
                    favBtn.innerHTML = '<span class="material-symbols-outlined">star</span>';
                    favBtn.classList.add('favorited');
                }
                loadAndDisplayFavorites();
            };
            li.appendChild(info);
            li.appendChild(favBtn);
            routeList.appendChild(li);
        });
        resultsDiv.style.display = 'block';
    }

    function getArrivalInfo(routeId, busNumber, stationId, stationName, cityCode) {
        if (arrivalInterval) clearInterval(arrivalInterval);
        if (timerInterval) clearInterval(timerInterval);
        const arrivalTitle = document.getElementById('arrival-title');
        arrivalTitle.textContent = `${busNumber}번 버스 도착 정보`;
        document.getElementById('arrival-info').style.display = 'block';
        const url = `/api/arrival-info?cityCode=${cityCode}&nodeId=${stationId}&routeId=${routeId}&busNumber=${busNumber}&stationName=${stationName}`;
        const timerEl = document.getElementById('arrival-timer');
        const updateAll = () => {
            fetchAndDisplayArrival(url);
            countdown = 30;
            timerEl.textContent = `${countdown}초 후 새로고침`;
        };
        updateAll();
        arrivalInterval = setInterval(updateAll, 30000);
        timerInterval = setInterval(() => {
            countdown--;
            timerEl.textContent = `${countdown}초 후 새로고침`;
        }, 1000);
    }

    async function fetchAndDisplayArrival(url) {
        const arrivalDetails = document.getElementById('arrival-details');
        arrivalDetails.innerHTML = '';
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.length > 0) {
                // ✅ [수정] 도착 시간 순으로 정렬
                data.sort((a, b) => a.arrtime - b.arrtime);

                data.forEach((bus, index) => {
                    const arrivalTimeMin = Math.floor(bus.arrtime / 60);
                    const remainingStops = bus.arrprevstationcnt;
                    const entry = document.createElement('div');
                    entry.className = 'arrival-entry';
                    let label = index === 0 ? '<span class="material-symbols-outlined" style="font-size: 1.1em; vertical-align: middle;">directions_bus</span> 곧 도착' : '<span class="material-symbols-outlined" style="font-size: 1.1em; vertical-align: middle;">bus_alert</span> 다음 버스';
                    entry.innerHTML = `<p><span class="label">${label}</span>: <b>${arrivalTimeMin}분 후</b> 도착 예정</p>
                                       <p>(${remainingStops}개 정류장 남음)</p>`;
                    arrivalDetails.appendChild(entry);
                });
            } else {
                arrivalDetails.innerHTML = '<p style="text-align: center; color: #777;">현재 도착 정보가 없습니다.<br>(운행 종료 또는 출발 전일 수 있습니다)</p>';
            }
        } catch (error) {
            arrivalDetails.innerHTML = '<p style="text-align: center; color: #d93025;">오류: 도착 정보를 갱신하지 못했습니다.</p>';
        }
    }

    async function askPermissionAndSubscribe(swReg) {
        const permission = await window.Notification.requestPermission();
        if (permission !== 'granted') { alert('알림 권한이 거부되었습니다.'); throw new Error('Permission not granted'); }
        const subscription = await swReg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY) });
        await fetch('/api/save-subscription', { method: 'POST', body: JSON.stringify(subscription), headers: { 'Content-Type': 'application/json' } });
        alert('바탕화면 알림이 성공적으로 설정되었습니다!');
        const notificationButton = document.getElementById('notification-button');
        notificationButton.innerHTML = '<span class="material-symbols-outlined">notifications_active</span> 알림 설정 완료!';
        notificationButton.disabled = true;
        notificationButton.style.backgroundColor = '#198754';
    }

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
        return outputArray;
    }

    function clearAllResults() {
        if (arrivalInterval) clearInterval(arrivalInterval);
        if (timerInterval) clearInterval(timerInterval);
        document.getElementById('error-message').style.display = 'none';
        document.getElementById('station-choices').style.display = 'none';
        document.getElementById('results').style.display = 'none';
        document.getElementById('arrival-info').style.display = 'none';
    }

    function showLoader(isLoading, message = "조회하는 중...") {
        const loader = document.querySelector('.loader');
        loader.style.display = isLoading ? 'flex' : 'none';
        loader.innerHTML = `<span></span> ${message}`;

        const searchButton = document.getElementById('search-button');
        searchButton.disabled = isLoading;
        if (isLoading) {
            searchButton.innerHTML = '<span class="material-symbols-outlined" style="animation: spin 1s linear infinite; font-size: 1.1em; line-height: 1;">progress_activity</span><span style="margin-left: 8px;">조회 중...</span>';
        } else {
            searchButton.innerHTML = '조회하기';
        }
    }

    function showError(message) {
        const errorMessage = document.getElementById('error-message');
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';

        document.querySelector('.loader').style.display = 'none';
        const searchButton = document.getElementById('search-button');
        searchButton.disabled = false;
        searchButton.innerHTML = '조회하기';
    }

    document.getElementById('search-query').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') { searchStation(); }
    });
</script>
</body>
</html>